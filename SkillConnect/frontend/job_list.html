{% extends "base.html" %}
{% load static %}

{% block title %}Jobs | SkillConnect{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6">

  <h2 class="text-3xl font-bold mb-6 text-center text-indigo-700">Available Jobs</h2>

  <!-- üîç Search & Filter -->
  <div class="flex flex-wrap gap-3 mb-6 items-center justify-center">
    <input type="text" id="searchInput" placeholder="Search by Job ID or Title"
      class="border rounded-lg px-3 py-2 w-64 shadow-sm focus:ring-2 focus:ring-indigo-400 focus:outline-none">

    <input type="text" id="techStackInput" placeholder="Tech stack (e.g. Django, React)"
      class="border rounded-lg px-3 py-2 w-56 shadow-sm focus:ring-2 focus:ring-indigo-400 focus:outline-none">

    <input type="number" id="minPayInput" placeholder="Min Pay/hr"
      class="border rounded-lg px-3 py-2 w-32 shadow-sm focus:ring-2 focus:ring-indigo-400 focus:outline-none">
    <input type="number" id="maxPayInput" placeholder="Max Pay/hr"
      class="border rounded-lg px-3 py-2 w-32 shadow-sm focus:ring-2 focus:ring-indigo-400 focus:outline-none">

    <select id="sortSelect" class="border rounded-lg px-3 py-2 shadow-sm focus:ring-2 focus:ring-indigo-400 focus:outline-none">
      <option value="">Sort: Newest</option>
      <option value="pay_high">Pay: High ‚Üí Low</option>
      <option value="pay_low">Pay: Low ‚Üí High</option>
    </select>

    <button onclick="loadJobs()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition">Search</button>
  </div>

  <div id="jobsContainer" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</div>

<script>
async function loadJobs(){
  const token = localStorage.getItem('access');

  // collect search/filter values
  const search = document.getElementById('searchInput').value.trim();
  const techStack = document.getElementById('techStackInput').value.trim();
  const minPay = document.getElementById('minPayInput').value.trim();
  const maxPay = document.getElementById('maxPayInput').value.trim();
  const sort = document.getElementById('sortSelect').value;

  // build query params
  const params = new URLSearchParams();
  if(search) params.append("search", search);
  if(techStack) params.append("tech_stack", techStack);
  if(minPay) params.append("min_pay", minPay);
  if(maxPay) params.append("max_pay", maxPay);
  if(sort) params.append("sort", sort);

  const res = await fetch(`/api/jobs/?${params.toString()}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await res.json();
  const container = document.getElementById('jobsContainer');
  container.innerHTML = '';

  if(!Array.isArray(data) || data.length === 0){
    container.innerHTML = '<p class="col-span-full text-center text-gray-500">No jobs found.</p>';
    return;
  }

  data.forEach(job => {
    const card = document.createElement('div');
    card.className = 'bg-white rounded-2xl shadow-md hover:shadow-lg transition p-5 flex flex-col';

    const imageHtml = job.image ? `<img src="${job.image}" alt="Job image" class="w-full h-40 object-cover rounded-lg mb-3">` : '';

    card.innerHTML = `
      ${imageHtml}
      <h3 class="text-lg font-semibold mb-1">${job.title}</h3>
      <p class="text-sm text-gray-500 mb-2">By <span class="font-medium">${job.recruiter || "Recruiter"}</span></p>
      <p class="text-sm text-gray-600">${job.tech_stack || ''}</p>
      <p class="text-gray-700 mt-2 text-sm">${(job.description || '').substring(0, 120)}...</p>
      <div class="mt-3 text-sm">
        ${job.pay_per_hour ? `<p><span class="font-medium">üí∞ Pay/hour:</span> $${job.pay_per_hour}</p>` : ''}
        ${job.experience_level ? `<p><span class="font-medium">üìà Level:</span> ${job.experience_level}</p>` : ''}
      </div>
      <div class="mt-auto pt-4 flex gap-2">
        <button class="applyBtn px-3 py-1 bg-green-500 text-white rounded-lg text-sm" data-id="${job.id}">Apply</button>
        <button class="favBtn px-3 py-1 bg-pink-500 text-white rounded-lg text-sm" data-id="${job.id}">‚ù§ Favorite</button>
        <a href="/job_detail/?id=${job.id}" class="px-3 py-1 border border-gray-300 rounded-lg text-sm">Details</a>
      </div>
    `;
    container.appendChild(card);
  });

  document.querySelectorAll('.applyBtn').forEach(b => b.onclick = applyToJob);
  document.querySelectorAll('.favBtn').forEach(b => b.onclick = toggleFavorite);
}

async function applyToJob(e){
  const id = e.currentTarget.dataset.id;
  const token = localStorage.getItem('access');
  const cover = prompt('Write a short cover letter (optional):') || '';
  const res = await fetch(`/api/jobs/${id}/apply/`, {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
    body: JSON.stringify({ cover_letter: cover })
  });
  if (res.ok) {
    alert('‚úÖ Applied successfully!');
  } else {
    const j = await res.json().catch(()=>({detail:'Unknown error'}));
    alert('‚ùå Error: ' + (j.detail || JSON.stringify(j)));
  }
}

async function toggleFavorite(e){
  const id = e.currentTarget.dataset.id;
  const token = localStorage.getItem('access');
  const res = await fetch(`/api/jobs/${id}/favorite/`, {
    method: 'POST',
    headers: { 'Authorization': `Bearer ${token}` }
  });
  const j = await res.json().catch(()=>({detail:'Done'}));
  alert(j.detail || 'Done');
}

document.addEventListener('DOMContentLoaded', loadJobs);
</script>
{% endblock %}
