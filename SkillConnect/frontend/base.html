{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}SkillConnect{% endblock %}</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{% static 'style.css' %}">

  <style>
    body {
      background: linear-gradient(to bottom right, #eef2ff, #e0e7ff);
      min-height: 100vh;
      overflow-x: hidden;
    }
    .bubbles { position: fixed; width: 100%; height: 100%; top: 0; left: 0; z-index: 0; pointer-events: none; overflow: hidden; }
    .bubble { position: absolute; bottom: -150px; background: rgba(99, 102, 241, 0.25); border-radius: 50%; animation: rise linear infinite; }
    @keyframes rise {
      0% { transform: translateY(0) scale(1); opacity: 0.8; }
      100% { transform: translateY(-120vh) scale(1.3); opacity: 0; }
    }
  </style>
</head>
<body class="text-gray-900 flex flex-col relative">

  <!-- Background bubbles -->
  <div class="bubbles">
    <div class="bubble" style="width:40px;height:40px;left:10%;animation-duration:18s;"></div>
    <div class="bubble" style="width:70px;height:70px;left:25%;animation-duration:25s;"></div>
    <div class="bubble" style="width:25px;height:25px;left:40%;animation-duration:15s;"></div>
    <div class="bubble" style="width:90px;height:90px;left:55%;animation-duration:28s;"></div>
    <div class="bubble" style="width:50px;height:50px;left:70%;animation-duration:20s;"></div>
    <div class="bubble" style="width:30px;height:30px;left:85%;animation-duration:16s;"></div>
  </div>

  <!-- Navbar -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-extrabold text-indigo-700">
        <a href="{% url 'home' %}">SkillConnect</a>
      </h1>
      <nav class="flex items-center space-x-6 text-lg font-medium" id="navbarLinks">
        <!-- Guest links -->
        <span id="guestLinks">
          <a href="{% url 'register' %}" class="hover:text-indigo-600 transition">Register</a>
          <a href="{% url 'login' %}" class="hover:text-indigo-600 transition">Login</a>
        </span>

        <!-- Logged-in user links (dynamically populated) -->
        <span id="userLinks" class="hidden flex items-center space-x-6">
          <!-- Links added by JS -->
        </span>
      </nav>
    </div>
  </header>

  <!-- Content -->
  <main class="flex-1 relative z-10">
    {% block content %}{% endblock %}
  </main>

  <!-- Footer -->
  <footer class="bg-gradient-to-r from-indigo-700 to-indigo-900 text-gray-200 mt-16 relative z-10">
    <div class="max-w-7xl mx-auto px-6 py-10 grid md:grid-cols-2 gap-6">
      <div class="space-y-3">
        <h2 class="text-2xl font-bold text-white">SkillConnect</h2>
        <p>Connecting freelancers and recruiters with opportunities worldwide.</p>
      </div>
      <div class="text-left md:text-right">
        <p>&copy; 2025 SkillConnect. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    // Refresh notifications badge
    async function refreshUnreadBadge(){
      const token = localStorage.getItem('access');
      if(!token) return;
      try {
        const res = await fetch('/api/jobs/notifications/', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) return;
        const data = await res.json();
        const unread = data.filter(n => !n.read).length;
        const badge = document.getElementById('notifBadge');
        if (unread > 0) {
          badge.textContent = unread > 99 ? '99+' : unread;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      } catch (_) {}
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const token = localStorage.getItem('access');
      const guestLinks = document.getElementById('guestLinks');
      const userLinks = document.getElementById('userLinks');

      if(token){
        guestLinks.classList.add('hidden');
        userLinks.classList.remove('hidden');

        // Get user info
        const res = await fetch('/api/me/', {
          headers: { Authorization: `Bearer ${token}` }
        });
        if(res.ok){
          const user = await res.json();
          const links = [];

          // Profile always first
          links.push({ name: 'Profile', url: '/profile/' });

          if(user.role === 'freelancer'){
            links.push({ name: 'Jobs', url: '{% url "job_list" %}' });
            links.push({ name: 'My Applications', url: '{% url "my_applications" %}' });
            links.push({ name: 'Favorites', url: '{% url "favorites" %}' });
          } else if(user.role === 'recruiter'){
            links.push({ name: 'Post Job', url: '{% url "job_post" %}' });
            links.push({ name: 'Recruiter Dashboard', url: '{% url "recruiter_dashboard" %}' });
          }

          // Notifications always last
          links.push({ name: 'Notifications', url: '/notifications/', id: 'notifLink' });

          // Clear existing links
          userLinks.innerHTML = '';

          links.forEach(link => {
            const a = document.createElement('a');
            a.href = link.url;
            a.className = 'hover:text-indigo-600 transition flex items-center';
            a.textContent = link.name;

            if(link.id === 'notifLink'){
              const span = document.createElement('span');
              span.id = 'notifBadge';
              span.className = 'hidden ml-2 text-xs bg-red-600 text-white rounded-full px-2 py-0.5 leading-none';
              a.appendChild(span);
            }

            userLinks.appendChild(a);
          });
        }
      }

      refreshUnreadBadge();
      setInterval(refreshUnreadBadge, 30000);
    });
  </script>
</body>
</html>
